<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>KnP –ú–∞–≥–∞–∑–∏–Ω</title>
</head>
<body>
  <h1>KnP –ú–∞–≥–∞–∑–∏–Ω</h1>

  <div id="auth-section">
    <h2>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input id="username" placeholder="–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –∏–º–µ"><br>
    <input id="password" placeholder="–ü–∞—Ä–æ–ª–∞" type="password"><br>
    <button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    <button onclick="login()">–í—Ö–æ–¥</button>
    <p id="auth-status"></p>
  </div>

  <hr>

  <h2>–°–ø–∏—Å—ä–∫ —Å –ø—Ä–æ–¥—É–∫—Ç–∏</h2>
  <ul id="product-list"></ul>

  <div id="add-section" style="display:none;">
    <h2>–î–æ–±–∞–≤–∏ –ø—Ä–æ–¥—É–∫—Ç</h2>
    <input id="name" placeholder="–ò–º–µ"><br>
    <input id="desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"><br>
    <button onclick="addProduct()">–î–æ–±–∞–≤–∏</button>
  </div>

<script>
  const API = "http://127.0.0.1:5000";

  function saveToken(token, userId) {
    localStorage.setItem("token", token);
    localStorage.setItem("user_id", userId);
    document.getElementById("auth-status").textContent = "–í–ª—è–∑—ä–ª —Å–∏!";
    document.getElementById("add-section").style.display = "block";
  }

  async function register() {
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;

    const res = await fetch(`${API}/auth/register`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    });

    const data = await res.json();
    alert(data.message || data.error);
  }

  async function login() {
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;

    const res = await fetch(`${API}/auth/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    });

    const data = await res.json();
    if (data.token) {
      const payload = parseJwt(data.token);
      saveToken(data.token, payload.sub);
    } else {
      document.getElementById("auth-status").textContent = data.error;
    }
  }

  function parseJwt(token) {
    try {
      const payload = token.split('.')[1];
      return JSON.parse(atob(payload));
    } catch (e) {
      return null;
    }
  }

  async function loadProducts() {
    const res = await fetch(`${API}/api/products`);
    const products = await res.json();
    const list = document.getElementById("product-list");
    list.innerHTML = "";

    for (const p of products) {
      const li = document.createElement("li");
      li.innerHTML = `<strong>${p.title}</strong>: ${p.description}`;

      const currentUserId = localStorage.getItem("user_id");
      if (currentUserId && Number(currentUserId) === p.user_id) {
        const btn = document.createElement("button");
        btn.textContent = "üóëÔ∏è";
        btn.onclick = () => deleteProduct(p.id);
        li.appendChild(btn);
      }

      const commentsBox = document.createElement("ul");
      const commentRes = await fetch(`${API}/api/products/${p.id}/comments`);
      const comments = await commentRes.json();
      comments.forEach(c => {
        const cLi = document.createElement("li");
        cLi.textContent = c.text;
        commentsBox.appendChild(cLi);
      });
      li.appendChild(commentsBox);

      if (localStorage.getItem("token")) {
        const input = document.createElement("input");
        input.placeholder = "–ù–∞–ø–∏—à–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä";
        const btn = document.createElement("button");
        btn.textContent = "–ö–æ–º–µ–Ω—Ç–∏—Ä–∞–π";
        btn.onclick = () => addComment(p.id, input.value);
        li.appendChild(input);
        li.appendChild(btn);
      }

      list.appendChild(li);
    }
  }

  async function deleteProduct(id) {
    const token = localStorage.getItem("token");
    const res = await fetch(`${API}/api/products/${id}`, {
      method: "DELETE",
      headers: { Authorization: "Bearer " + token }
    });
    const data = await res.json();
    alert(data.message || data.error);
    loadProducts();
  }

  async function addComment(productId, text) {
    const token = localStorage.getItem("token");
    await fetch(`${API}/api/products/${productId}/comments`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ text })
    });
    loadProducts();
  }

  async function addProduct() {
    const token = localStorage.getItem("token");
    const name = document.getElementById("name").value;
    const desc = document.getElementById("desc").value;

    const res = await fetch(`${API}/api/products`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ title: name, description: desc })
    });

    const data = await res.json();
    alert(data.message || data.error);
    loadProducts();
  }

  loadProducts();
</script>
</body>
</html>